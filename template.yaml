AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
Globals:
  Function:
    Timeout: 3

Resources:
  DBTABLE:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - 
          AttributeName: "FoodID"
          AttributeType: "S"
      KeySchema:
        - 
          AttributeName: "FoodID"
          KeyType: "HASH"
      ProvisionedThroughput: 
        ReadCapacityUnits: "5"
        WriteCapacityUnits: "5"
      TableName: "myFoodTable"


  HelloWorldFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: hello_world/
      Handler: app.lambda_handler
      Role: !GetAtt LambdaRole.Arn
      Runtime: python3.9
      Architectures:
        - x86_64
      Events:
        HelloWorld:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /foods
            Method: GET
            Auth:
              Authorizer: MyAuthorizer

        HelloWorldFood:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /food
            Method: POST
            Auth:
              Authorizer: MyAuthorizer


  SignUpFunction:
    Type: AWS::Serverless::Function
    Properties:
      Environment:
        Variables:
          USER_POOL_CLIENT_ID:
            Ref: CognitoUserPoolClient
      CodeUri: signup/
      Handler: signup.lambda_handler
      Role: !GetAtt LambdaRole.Arn
      Runtime: python3.9
      Architectures:
        - x86_64
      Events:
        SingingUp:
          Type: Api
          Properties:
            RestApiId: !Ref SignUpApi
            Path: /user
            Method: POST


  LoginUpFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: signup/
      Handler: login.lambda_handler
      Environment:
        Variables:
          USER_POOL_ID:
            Ref: CognitoUserPool
          USER_POOL_CLIENT_ID:
            Ref: CognitoUserPoolClient
      Role: !GetAtt LambdaRole.Arn
      Runtime: python3.9
      Architectures:
        - x86_64
      Events:
        LoggingIn:
          Type: Api
          Properties:
            RestApiId: !Ref SignUpApi
            Path: /user-info
            Method: POST


  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: sam-user-pool
      Policies:
        PasswordPolicy:
          MinimumLength: 8
      UsernameAttributes:
        - email
      AutoVerifiedAttributes:
        - email
      Schema:
        - AttributeDataType: String
          Name: email
          Required: false


  CognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: sam-user-pool-client
      UserPoolId: !Ref CognitoUserPool
      ExplicitAuthFlows:
        - ADMIN_NO_SRP_AUTH
      GenerateSecret: false


  MyAuthFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: authorizer/
      Handler: handler.lambda_handler
      Runtime: python3.9
      FunctionName: my-authorizer-func


  MyApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Cors: "'*'"
      Auth:
        DefaultAuthorizer: MyAuthorizer
        Authorizers:
          MyAuthorizer:
            FunctionArn: !GetAtt MyAuthFunction.Arn
            Identity:
               Header: authorizationToken


  SignUpApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Cors: "'*'"


  ConfigLambdaPermission:
    Type: "AWS::Lambda::Permission"
    DependsOn:
    - MyApi
    - MyAuthFunction
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref MyAuthFunction
      Principal: apigateway.amazonaws.com


  LambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
          -
            PolicyName: LambdaRolePolicy
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                -
                  Effect: Allow
                  Action:
                    - cognito-idp:AdminInitiateAuth
                    - dynamodb:CreateTable
                    - dynamodb:GetItem
                    - dynamodb:PutItem
                    - dynamodb:Scan
                    - lambda:InvokeFunction
                  Resource:
                    - !GetAtt DBTABLE.Arn
                    - !GetAtt CognitoUserPool.Arn